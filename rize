#!/bin/bash
set -e

# Colors for output
CYAN='\033[0;36m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
RED='\033[0;31m'
NC='\033[0m' # No Color

# Embedded Dockerfile content
DOCKERFILE_CONTENT=$(cat <<'DOCKERFILE_EOF'
FROM ubuntu:24.04

# Build-time arguments for multiple versions (comma-separated)
ARG GO_VERSIONS=1.23.3,1.22.5
ARG NODE_VERSIONS=24
ARG RUBY_VERSIONS=3.1.7,3.4.7
ARG PYTHON_VERSIONS=3.13.0
ARG NODE_DEFAULT=24
ARG CLAUDE_CODE_VERSION=latest
ARG CODEX_VERSION=latest

# Non-interactive setup
ENV DEBIAN_FRONTEND=noninteractive \
    PATH="/home/agent/.linuxbrew/bin:/home/agent/.linuxbrew/sbin:/home/agent/.local/bin:/home/agent/.local/go/bin:/home/agent/.local/share/mise/shims:$PATH" \
    HOME=/home/agent \
    USER=agent \
    IS_SANDBOX=1 \
    SHELL=/bin/zsh \
    EDITOR=vim \
    LANG=en_US.UTF-8 \
    LC_ALL=en_US.UTF-8

# Install system dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    vim \
    nano \
    less \
    build-essential \
    git \
    git-lfs \
    curl \
    wget \
    httpie \
    locales \
    ca-certificates \
    bash \
    zsh \
    ripgrep \
    fd-find \
    bat \
    jq \
    unzip \
    fzf \
    yq \
    tree \
    dnsutils \
    gh \
    glab \
    sqlite3 \
    postgresql-client \
    redis-tools \
    mysql-client \
    zip \
    tar \
    rsync \
    htop \
    lsof \
    file \
    python3 \
    python3-pip \
    python3-venv \
    python3-virtualenv \
    pipx \
    cargo \
    libssl-dev \
    zlib1g-dev \
    libreadline-dev \
    libyaml-dev \
    libpq-dev \
    && ln -s /usr/bin/fdfind /usr/local/bin/fd \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Generate UTF-8 locale
RUN locale-gen en_US.UTF-8 && update-locale LANG=en_US.UTF-8 LC_ALL=en_US.UTF-8

# Create non-root user with home directory
RUN if id ubuntu >/dev/null 2>&1; then userdel -r ubuntu; fi && \
    useradd -m -u 1000 -s /bin/bash agent && \
    mkdir -p /home/agent/workspace /home/agent/.claude-config /home/agent/.local && \
    chown -R agent:agent /home/agent && \
    chmod 755 /home/agent

# Install zsh with powerline10k theme (from Claude Code's devcontainer)
ARG ZSH_IN_DOCKER_VERSION=1.2.1
RUN sh -c "$(wget -O- https://github.com/deluan/zsh-in-docker/releases/download/v${ZSH_IN_DOCKER_VERSION}/zsh-in-docker.sh)" -- \
  -x -u agent

# Disable git status in powerlevel10k
RUN printf 'typeset -g POWERLEVEL9K_DISABLE_GITSTATUS=true\n' >> /home/agent/.zshrc

# Add fzf configuration to zshrc if fzf is available
RUN if [ -f /usr/share/doc/fzf/examples/key-bindings.zsh ]; then \
      echo "# FZF configuration" >> /home/agent/.zshrc && \
      echo "source /usr/share/doc/fzf/examples/key-bindings.zsh" >> /home/agent/.zshrc && \
      echo "source /usr/share/doc/fzf/examples/completion.zsh" >> /home/agent/.zshrc; \
    fi

# Install mise using official installer
RUN curl https://mise.run | sh && \
    mv /home/agent/.local/bin/mise /usr/local/bin/mise

# Final home ownership fix before switching users
RUN chown -R agent:agent /home/agent

# Create entrypoint script that initializes mise and handles commands
RUN printf '#!/bin/bash\nset -e\nexport MISE_TRUSTED_CONFIG=1\ncd /home/agent/workspace\nif [ -f /home/agent/.env ]; then\n  set -a\n  source /home/agent/.env\n  set +a\nfi\nif [ -f ./.mise.toml ]; then\n  mise trust ./.mise.toml 2>/dev/null || true\nfi\nmise install 2>/dev/null || true\neval "$(mise activate bash 2>/dev/null || true)"\nNPM_PREFIX=$(mise exec node -- npm config get prefix 2>/dev/null || echo "")\nif [ -n "$NPM_PREFIX" ]; then\n  NPM_BIN="$NPM_PREFIX/bin"\n  if [ -d "$NPM_BIN" ]; then\n    export PATH="$NPM_BIN:$PATH"\n  fi\nfi\nif [ $# -eq 0 ]; then\n    exec /bin/zsh -l\nelse\n    exec "$@"\nfi\n' > /usr/local/bin/docker-entrypoint.sh && chmod +x /usr/local/bin/docker-entrypoint.sh

# Install Homebrew in standard location for binary support
RUN mkdir -p /home/linuxbrew/.linuxbrew && \
    chown -R agent:agent /home/linuxbrew && \
    chmod -R 755 /home/linuxbrew

# Switch to agent user for subsequent installations
USER agent

# Install Homebrew as agent (non-interactive)
RUN git clone https://github.com/Homebrew/brew /home/linuxbrew/.linuxbrew/Homebrew && \
    mkdir -p /home/linuxbrew/.linuxbrew/bin && \
    ln -s ../Homebrew/bin/brew /home/linuxbrew/.linuxbrew/bin/brew && \
    eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)" && \
    brew update --force --quiet && \
    cat <<'BREWRC' >> ~/.zshrc
eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
BREWRC
RUN cat <<'BREWRC' >> ~/.bashrc
eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
BREWRC

# Initialize mise
RUN mise --version

# Set global defaults for Ruby
RUN /bin/bash -c 'cd /home/agent; RUBY_DEFAULT=$(echo "$RUBY_VERSIONS" | cut -d, -f1); echo "Setting Ruby default: ${RUBY_DEFAULT}"; mise use -g ruby@"$RUBY_DEFAULT"'

# Pre-install all requested Ruby versions (done separately to avoid timeout)
RUN /bin/bash -c 'IFS="," read -ra RUBY_LIST <<< "$RUBY_VERSIONS"; echo "Pre-installing Ruby versions: ${RUBY_LIST[*]}"; for v in "${RUBY_LIST[@]}"; do mise install ruby@"$v"; done'

# Set global default for Python and pre-install versions
RUN /bin/bash -c 'cd /home/agent; PYTHON_DEFAULT=$(echo "$PYTHON_VERSIONS" | cut -d, -f1); echo "Setting Python default: ${PYTHON_DEFAULT}"; mise use -g python@"$PYTHON_DEFAULT"'

# Pre-install all requested Python versions (done separately to avoid timeout)
RUN /bin/bash -c 'IFS="," read -ra PYTHON_LIST <<< "$PYTHON_VERSIONS"; echo "Pre-installing Python versions: ${PYTHON_LIST[*]}"; for v in "${PYTHON_LIST[@]}"; do mise install python@"$v"; done'

# Set global default for Go and pre-install versions
RUN /bin/bash -c 'cd /home/agent; GO_DEFAULT=$(echo "$GO_VERSIONS" | cut -d, -f1); echo "Setting Go default: ${GO_DEFAULT}"; mise use -g go@"$GO_DEFAULT"; IFS="," read -ra GO_LIST <<< "$GO_VERSIONS"; echo "Pre-installing Go versions: ${GO_LIST[*]}"; for v in "${GO_LIST[@]}"; do mise install go@"$v"; done'

# Set global default for Node and pre-install versions
RUN /bin/bash -c 'cd /home/agent; NODE_DEFAULT="${NODE_DEFAULT}"; echo "Setting Node default: ${NODE_DEFAULT}"; mise use -g node@"$NODE_DEFAULT"; echo "Pre-installing default Node version: ${NODE_DEFAULT}"; mise install node@"$NODE_DEFAULT"; IFS="," read -ra NODE_LIST <<< "$NODE_VERSIONS"; echo "Pre-installing Node versions: ${NODE_LIST[*]}"; for v in "${NODE_LIST[@]}"; do mise install node@"$v"; done'

# Install Claude Code and Codex using the default Node version
RUN NODE_DEFAULT="${NODE_DEFAULT}" && \
    cd /home/agent && \
    mise exec node@$NODE_DEFAULT -- npm install -g \
      @anthropic-ai/claude-code@${CLAUDE_CODE_VERSION} \
      @openai/codex@${CODEX_VERSION} \
      opencode-ai \
      pnpm \
      yarn \
      eslint \
      prettier

# Install Go tools (user bin to avoid permission issues)
RUN GO_DEFAULT=$(echo "$GO_VERSIONS" | cut -d, -f1) && \
    mkdir -p /home/agent/.local/go/bin && \
    GOBIN=/home/agent/.local/go/bin mise exec go@$GO_DEFAULT -- go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest && \
    GOBIN=/home/agent/.local/go/bin mise exec go@$GO_DEFAULT -- go install github.com/go-delve/delve/cmd/dlv@latest

# Install Ruby tools
RUN RUBY_DEFAULT=$(echo "$RUBY_VERSIONS" | cut -d, -f1) && \
    mise exec ruby@$RUBY_DEFAULT -- gem install --no-document bundler rubocop

# Install Python tools via pipx
RUN pipx ensurepath && \
    pipx install uv && \
    pipx install yq || true

# Set working directory
WORKDIR /home/agent/workspace

# Use exec form entrypoint with bash
ENTRYPOINT ["/bin/bash", "/usr/local/bin/docker-entrypoint.sh"]
CMD []
DOCKERFILE_EOF
)

# Default versions
DEFAULT_GO_VERSIONS="1.23.3,1.22.5"
DEFAULT_RUBY_VERSIONS="3.1.7,3.4.7"
DEFAULT_PYTHON_VERSIONS="3.13.0"
DEFAULT_NODE_VERSIONS="24"
DEFAULT_NODE_DEFAULT="24"
DEFAULT_CLAUDE_CODE_VERSION="latest"
DEFAULT_CODEX_VERSION="latest"

# Variables to track what was provided
GO_VERSIONS=""
RUBY_VERSIONS=""
PYTHON_VERSIONS=""
NODE_VERSIONS=""
NODE_DEFAULT=""
CLAUDE_CODE_VERSION=""
CODEX_VERSION=""
COMMAND=""
ARGS=()

# Function to ensure docker volume exists
ensure_volume() {
    if ! docker volume inspect agent-data >/dev/null 2>&1; then
        echo -e "${BLUE}Creating agent-data volume for persistent storage...${NC}"
        docker volume create agent-data >/dev/null 2>&1
    fi
}

# Determine correct TTY flag for docker
get_tty_flag() {
    if [[ -t 0 ]]; then
        echo "-it"
    else
        echo "-i"
    fi
}

# Reset extra mount tracking
reset_mount_state() {
    EXTRA_MOUNT_FLAGS=()
    USED_MOUNT_NAMES=()
}

# Determine correct md5 command
get_md5() {
    if command -v md5sum >/dev/null 2>&1; then
        echo "$1" | md5sum | cut -d' ' -f1
    else
        echo "$1" | md5 | cut -d' ' -f1
    fi
}

# Portable xargs -r for macOS/Linux
xargs_run() {
    if [[ "$OSTYPE" == "darwin"* ]]; then
        # macOS xargs doesn't have -r, but we can check if stdin is empty
        local input
        input=$(cat)
        if [[ -n "$input" ]]; then
            echo "$input" | xargs "$@"
        fi
    else
        xargs -r "$@"
    fi
}

# Check if docker is running
check_docker() {
    if ! docker info >/dev/null 2>&1; then
        echo -e "${RED}Error: Docker is not running or you don't have permissions.${NC}"
        echo -e "${YELLOW}Please start Docker and try again.${NC}"
        exit 1
    fi
}

# Build common docker run flags
# Usage: DOCKER_FLAGS=$(build_docker_run_flags [config_dir])
build_docker_run_flags() {
    local config_dir="${1:-/home/agent/.claude-config}"
    local flags=()

    # Generate project-specific vendor volume name (sanitize for docker)
    local project_name=$(basename "$(pwd)" | tr -cd '[:alnum:]_.-')
    local project_hash=$(get_md5 "$(pwd)" | cut -c1-8)
    local vendor_volume="rize-vendor-${project_name}-${project_hash}"

    flags+=(
        "-v" "$(pwd):/home/agent/workspace"
        "-v" "${vendor_volume}:/home/agent/workspace/vendor"
        "-v" "agent-data:/home/agent/.claude-config"
        "-e" "CLAUDE_CONFIG_DIR=$config_dir"
    )

    # Add CLAUDE.md mount if it exists
    if [[ -f "$HOME/.claude/CLAUDE.md" ]]; then
        flags+=("-v" "$HOME/.claude/CLAUDE.md:$config_dir/CLAUDE.md")
    fi

    # Add .env mount if it exists (read-only for safety)
    if [[ -f "$HOME/.env" ]]; then
        flags+=("-v" "$HOME/.env:/home/agent/.env:ro")
    fi

    # Add .netrc mount if it exists (read-only for safety)
    if [[ -f "$HOME/.netrc" ]]; then
        flags+=("-v" "$HOME/.netrc:/home/agent/.netrc:ro")
    fi

    # Add extra mounts
    flags+=("${EXTRA_MOUNT_FLAGS[@]}")

    # Output flags separated by null bytes to handle spaces correctly
    printf '%s\0' "${flags[@]}"
}

# Generate a unique mount name to avoid collisions (e.g., repo, repo-2, repo-3)
dedupe_mount_name() {
    local base="$1"
    local candidate="$base"
    local count=2
    while :; do
        local found=0
        for existing in "${USED_MOUNT_NAMES[@]}"; do
            if [[ "$candidate" == "$existing" ]]; then
                found=1
                break
            fi
        done
        if [[ $found -eq 0 ]]; then
            USED_MOUNT_NAMES+=("$candidate")
            echo "$candidate"
            return
        fi
        candidate="${base}-${count}"
        count=$((count + 1))
    done
}

# Parse a single --path/--mount spec of the form host[:name]
add_mount_spec() {
    local spec="$1"
    local host="${spec%%:*}"
    local name="${spec#*:}"
    if [[ "$name" == "$spec" ]]; then
        name=""
    fi
    if [[ -z "$host" ]]; then
        return
    fi
    if [[ -z "$name" ]]; then
        name=$(basename "$host")
    fi
    if [[ -z "$name" ]]; then
        name="mount"
    fi
    name=$(dedupe_mount_name "$name")
    local target="/home/agent/mounts/$name"
    EXTRA_MOUNT_FLAGS+=(-v "$host:$target")
}

# Extract mount options from args, leaving the rest intact
parse_mount_args() {
    reset_mount_state
    PARSED_ARGS=()
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --path=*|--mount=*)
                add_mount_spec "${1#*=}"
                shift
                ;;
            --path|--mount)
                if [[ -n "${2:-}" ]]; then
                    add_mount_spec "$2"
                    shift 2
                else
                    shift
                fi
                ;;
            *)
                PARSED_ARGS+=("$1")
                shift
                ;;
        esac
    done
}

# Function to show usage
usage() {
    cat << EOF
${CYAN}Rize - Multi-Language AI Agent Container${NC}

${YELLOW}Usage:${NC}
  rize install [-y]                 Install rize globally to ~/.local/bin (use -y to overwrite)
  rize build [OPTIONS]              Build Docker image with specified versions
  rize shell                        Start interactive shell in container
  rize claude [args...]             Run claude code in container
  rize run <cmd> [args...]          Run a command in container
  rize exec <cmd> [args...]         Execute a command in container (alias for run)
  rize clean                        Clean up Docker system (images, cache, volumes)

${YELLOW}Build Options:${NC}
  --go=VERSION_LIST                 Comma-separated Go versions (default: ${DEFAULT_GO_VERSIONS})
  --ruby=VERSION_LIST               Comma-separated Ruby versions (default: ${DEFAULT_RUBY_VERSIONS})
  --python=VERSION_LIST             Comma-separated Python versions (default: ${DEFAULT_PYTHON_VERSIONS})
  --node=VERSION_LIST               Comma-separated Node.js versions (default: ${DEFAULT_NODE_VERSIONS})
  --node-default=VERSION            Default Node.js version used for global tools (default: ${DEFAULT_NODE_DEFAULT})
  --claude-code=VERSION             Claude Code npm version (default: ${DEFAULT_CLAUDE_CODE_VERSION})
  --codex=VERSION                   Codex npm version (default: ${DEFAULT_CODEX_VERSION})

${YELLOW}Examples:${NC}
  # Install globally
  rize install

  # Build with default versions
  rize build

  # Build with custom versions
  rize build --go=1.23.3,1.22.5 --ruby=3.1.7 --python=3.13.0 --node=24,22 --node-default=24 --claude-code=latest --codex=latest

  # Start interactive shell
  rize shell

  # Run claude code on current directory
  rize claude .

  # Check Go version
  rize exec go version

${YELLOW}Notes:${NC}
  - Current directory is mounted to /home/agent/workspace in container
  - Additional mounts: use --path /host[:name] (auto-placed at /home/agent/mounts/<name>, duplicates get a suffix)
  - Claude config persists in agent-volume across runs
  - Commands run with full mise environment

EOF
    exit 0
}

# Run docker with correctly parsed flags
run_rize() {
    ensure_volume
    
    local flags=()
    # Read null-terminated flags into array
    while IFS= read -r -d '' flag; do
        flags+=("$flag")
    done < <(build_docker_run_flags)
    
    local tty_flag=$(get_tty_flag)
    docker run --rm $tty_flag "${flags[@]}" rize:latest "$@"
}

# Parse command line arguments
if [[ $# -eq 0 ]]; then
    usage
fi

COMMAND="$1"
shift

case "$COMMAND" in
    install)
        FORCE_INSTALL="${FORCE_INSTALL:-false}"

        # Parse install options (-y/--yes to skip prompt)
        while [[ $# -gt 0 ]]; do
            case "$1" in
                -y|--yes)
                    FORCE_INSTALL="true"
                    shift
                    ;;
                *)
                    break
                    ;;
            esac
        done

        # Create ~/.local/bin if it doesn't exist
        mkdir -p "$HOME/.local/bin"

        # Check if already installed
        if [[ -f "$HOME/.local/bin/rize" ]] && [[ ! "$FORCE_INSTALL" == "true" ]]; then
            echo -e "${YELLOW}rize is already installed at $HOME/.local/bin/rize${NC}"
            read -p "Overwrite? (y/N): " -n 1 -r
            echo
            if [[ ! $REPLY =~ ^[Yy]$ ]]; then
                exit 0
            fi
        fi

        check_docker

        # Determine script source
        if [[ -f "$0" ]]; then
            SCRIPT_SRC="$0"
        else
            echo -e "${RED}Error: Cannot determine script source for installation.${NC}"
            echo -e "${YELLOW}Please use the recommended one-liner from README.${NC}"
            exit 1
        fi

        # Copy script
        cp "$SCRIPT_SRC" "$HOME/.local/bin/rize"
        chmod +x "$HOME/.local/bin/rize"

        # Create volume
        docker volume create agent-data 2>/dev/null || true

        echo -e "${GREEN}✓ rize installed successfully to $HOME/.local/bin/rize${NC}"
        echo ""

        # Check if image exists, build if not
        if ! docker image inspect rize:latest > /dev/null 2>&1; then
            echo -e "${YELLOW}Warning: The first-time build can take 15-30 minutes and requires ~5GB of space.${NC}"
            echo -e "${BLUE}Building Docker image...${NC}"
            "$HOME/.local/bin/rize" build
        else
            echo -e "${GREEN}✓ Docker image already built${NC}"
            echo ""
        fi

        # Check if ~/.local/bin is in PATH
        if [[ ":$PATH:" != *":$HOME/.local/bin:"* ]]; then
            echo -e "${YELLOW}Adding $HOME/.local/bin to PATH in ~/.bashrc and ~/.zshrc...${NC}"
            
            PATH_LINE='export PATH="$HOME/.local/bin:$PATH"'
            
            # Update .bashrc
            if [[ -f "$HOME/.bashrc" ]]; then
                if ! grep -qxF "$PATH_LINE" "$HOME/.bashrc"; then
                    echo "$PATH_LINE" >> "$HOME/.bashrc"
                    echo -e "${GREEN}✓ Added to ~/.bashrc${NC}"
                fi
            fi
            
            # Update .zshrc
            if [[ -f "$HOME/.zshrc" ]]; then
                if ! grep -qxF "$PATH_LINE" "$HOME/.zshrc"; then
                    echo "$PATH_LINE" >> "$HOME/.zshrc"
                    echo -e "${GREEN}✓ Added to ~/.zshrc${NC}"
                fi
            fi
            
            # Also export for current session
            export PATH="$HOME/.local/bin:$PATH"
        fi

        echo -e "${BLUE}You can now use 'rize' from any directory${NC}"
        echo ""
        echo -e "${YELLOW}Quick start:${NC}"
        echo "  cd ~/your-project"
        echo "  rize shell              # Interactive shell"
        echo "  rize exec go version    # Run commands"
        echo ""
        ;;

    build)
        check_docker

        # Parse build options
        while [[ $# -gt 0 ]]; do
            case "$1" in
                --go=*)
                    GO_VERSIONS="${1#--go=}"
                    shift
                    ;;
                --ruby=*)
                    RUBY_VERSIONS="${1#--ruby=}"
                    shift
                    ;;
                --python=*)
                    PYTHON_VERSIONS="${1#--python=}"
                    shift
                    ;;
                --node=*)
                    NODE_VERSIONS="${1#--node=}"
                    shift
                    ;;
                --node-default=*)
                    NODE_DEFAULT="${1#--node-default=}"
                    shift
                    ;;
                --claude-code=*)
                    CLAUDE_CODE_VERSION="${1#--claude-code=}"
                    shift
                    ;;
                --codex=*)
                    CODEX_VERSION="${1#--codex=}"
                    shift
                    ;;
                --help|-h)
                    usage
                    ;;
                *)
                    echo -e "${RED}Unknown option: $1${NC}"
                    usage
                    ;;
            esac
        done

        # Use defaults if not specified
        GO_VERSIONS="${GO_VERSIONS:-$DEFAULT_GO_VERSIONS}"
        RUBY_VERSIONS="${RUBY_VERSIONS:-$DEFAULT_RUBY_VERSIONS}"
        PYTHON_VERSIONS="${PYTHON_VERSIONS:-$DEFAULT_PYTHON_VERSIONS}"
        NODE_VERSIONS="${NODE_VERSIONS:-$DEFAULT_NODE_VERSIONS}"
        NODE_DEFAULT="${NODE_DEFAULT:-$DEFAULT_NODE_DEFAULT}"
        CLAUDE_CODE_VERSION="${CLAUDE_CODE_VERSION:-$DEFAULT_CLAUDE_CODE_VERSION}"
        CODEX_VERSION="${CODEX_VERSION:-$DEFAULT_CODEX_VERSION}"

        echo -e "${CYAN}========================================${NC}"
        echo -e "${CYAN}Building Rize Image${NC}"
        echo -e "${CYAN}========================================${NC}"
        echo ""
        echo -e "${BLUE}Versions:${NC}"
        echo "  Go:       $GO_VERSIONS"
        echo "  Ruby:     $RUBY_VERSIONS"
        echo "  Python:   $PYTHON_VERSIONS"
        echo "  Node:     $NODE_VERSIONS"
        echo "  Node default: $NODE_DEFAULT"
        echo "  Claude:   $CLAUDE_CODE_VERSION"
        echo "  Codex:    $CODEX_VERSION"
        echo ""
        echo -e "${YELLOW}Note: This build can take 15-30 minutes and requires ~5GB of disk space.${NC}"
        echo ""

        # Create temporary directory for Dockerfile
        TEMP_DIR=$(mktemp -d)
        trap "rm -rf $TEMP_DIR" EXIT

        # Write Dockerfile to temp directory
        echo "$DOCKERFILE_CONTENT" > "$TEMP_DIR/Dockerfile"

        # Build the Docker image with build args
        docker build \
            -t rize:latest \
            --build-arg "GO_VERSIONS=$GO_VERSIONS" \
            --build-arg "RUBY_VERSIONS=$RUBY_VERSIONS" \
            --build-arg "PYTHON_VERSIONS=$PYTHON_VERSIONS" \
            --build-arg "NODE_VERSIONS=$NODE_VERSIONS" \
            --build-arg "NODE_DEFAULT=$NODE_DEFAULT" \
            --build-arg "CLAUDE_CODE_VERSION=$CLAUDE_CODE_VERSION" \
            --build-arg "CODEX_VERSION=$CODEX_VERSION" \
            "$TEMP_DIR"

        echo ""
        echo -e "${GREEN}✓ Docker image built successfully!${NC}"
        echo ""
        echo -e "${YELLOW}Next steps:${NC}"
        echo "  # Start interactive shell"
        echo -e "  ${BLUE}rize shell${NC}"
        echo ""
        echo "  # Run a command"
        echo -e "  ${BLUE}rize run claude .${NC}"
        echo ""
        echo "  # Check versions"
        echo -e "  ${BLUE}rize exec go version${NC}"
        echo ""
        ;;

    shell)
        check_docker

        # Check if image exists
        if ! docker image inspect rize:latest > /dev/null 2>&1; then
            echo -e "${YELLOW}Image not found. Building with default versions...${NC}"
            "rize" build
        fi

        echo -e "${BLUE}Starting interactive shell...${NC}"

        parse_mount_args "$@"
        set -- "${PARSED_ARGS[@]}"

        run_rize
        ;;

    claude)
        check_docker

        # Check if image exists
        if ! docker image inspect rize:latest > /dev/null 2>&1; then
            echo -e "${YELLOW}Image not found. Building with default versions...${NC}"
            "rize" build
        fi

        parse_mount_args "$@"
        set -- "${PARSED_ARGS[@]}"

        run_rize claude --dangerously-skip-permissions "$@"
        ;;

    codex)
        check_docker

        # Check if image exists
        if ! docker image inspect rize:latest > /dev/null 2>&1; then
            echo -e "${YELLOW}Image not found. Building with default versions...${NC}"
            "rize" build
        fi

        parse_mount_args "$@"
        set -- "${PARSED_ARGS[@]}"

        run_rize codex --dangerously-bypass-approvals-and-sandbox "$@"
        ;;
    opencode)
        check_docker

        # Check if image exists
        if ! docker image inspect rize:latest > /dev/null 2>&1; then
            echo -e "${YELLOW}Image not found. Building with default versions...${NC}"
            "rize" build
        fi

        parse_mount_args "$@"
        set -- "${PARSED_ARGS[@]}"

        run_rize opencode "$@"
        ;;

    run|exec)
        check_docker

        # Check if image exists
        if ! docker image inspect rize:latest > /dev/null 2>&1; then
            echo -e "${YELLOW}Image not found. Building with default versions...${NC}"
            "rize" build
        fi

        parse_mount_args "$@"
        set -- "${PARSED_ARGS[@]}"

        if [[ $# -eq 0 ]]; then
            echo -e "${RED}Error: run/exec requires a command${NC}"
            usage
        fi

        echo -e "${BLUE}Running: $@${NC}"

        run_rize "$@"
        ;;

    clean)
        echo -e "${BLUE}Cleaning up Rize-related Docker resources...${NC}"
        echo ""

        check_docker

        echo -e "${BLUE}Removing Rize image...${NC}"
        docker image rm rize:latest 2>/dev/null || true

        echo -e "${BLUE}Removing dangling images...${NC}"
        docker image prune -f >/dev/null 2>&1

        echo -e "${BLUE}Removing Rize vendor volumes...${NC}"
        docker volume ls -q -f name=rize-vendor- | xargs_run docker volume rm 2>/dev/null || true

        echo ""
        echo -e "${GREEN}✓ Cleanup complete!${NC}"
        ;;

    --help|-h)
        usage
        ;;

    *)
        echo -e "${RED}Unknown command: $COMMAND${NC}"
        usage
        ;;
esac
