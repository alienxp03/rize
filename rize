#!/bin/bash
set -e

# Colors for output
CYAN='\033[0;36m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
RED='\033[0;31m'
NC='\033[0m' # No Color

# Embedded Dockerfile content
DOCKERFILE_CONTENT=$(cat <<'DOCKERFILE_EOF'
FROM ubuntu:24.04

# Build-time arguments for multiple versions (comma-separated)
ARG GO_VERSIONS=1.23.3,1.22.5
ARG RUBY_VERSIONS=3.3,3.2
ARG NODE_VERSIONS=24,22
ARG PYTHON_VERSIONS=3.12,3.11
ARG CLAUDE_CODE_VERSION=latest

# Non-interactive setup
ENV DEBIAN_FRONTEND=noninteractive \
    PATH="/home/agent/.local/bin:/home/agent/.local/share/mise/shims:$PATH" \
    HOME=/home/agent \
    USER=agent \
    IS_SANDBOX=1

# Set the default editor and visual
ENV EDITOR=vim

# Install system dependencies
RUN apt-get update --allow-insecure-repositories --allow-unauthenticated && apt-get install -y --no-install-recommends \
    build-essential \
    git \
    curl \
    wget \
    ca-certificates \
    bash \
    zsh \
    ripgrep \
    fd-find \
    bat \
    jq \
    unzip \
    fzf \
    && ln -s /usr/bin/fdfind /usr/local/bin/fd \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Create non-root user with home directory and make it world-writable
RUN useradd -m -s /bin/bash agent && \
    chmod 777 /home/agent && \
    mkdir -p /home/agent/.local && \
    chmod 777 /home/agent/.local

# Install zsh with powerline10k theme (from Claude Code's devcontainer)
ARG ZSH_IN_DOCKER_VERSION=1.2.0
RUN sh -c "$(wget -O- https://github.com/deluan/zsh-in-docker/releases/download/v${ZSH_IN_DOCKER_VERSION}/zsh-in-docker.sh)" -- \
  -p git \
  -x

# Make zsh the default shell for agent user
RUN chsh -s /bin/zsh agent

# Add fzf configuration to zshrc if fzf is available
RUN if [ -f /usr/share/doc/fzf/examples/key-bindings.zsh ]; then \
      echo "# FZF configuration" >> /home/agent/.zshrc && \
      echo "source /usr/share/doc/fzf/examples/key-bindings.zsh" >> /home/agent/.zshrc && \
      echo "source /usr/share/doc/fzf/examples/completion.zsh" >> /home/agent/.zshrc; \
    fi

# Install mise using official installer
RUN curl https://mise.run | sh && \
    mv ~/.local/bin/mise /usr/local/bin/mise

# Create workspace directory (as root, before switching user)
RUN mkdir -p /home/agent/workspace && chmod 777 /home/agent/workspace

# Create entrypoint script that initializes mise and handles commands
RUN printf '#!/bin/bash\nset -e\nexport MISE_TRUSTED_CONFIG=1\ncd /home/agent/workspace\n\n# Trust project mise config if present\nif [ -f ./.mise.toml ]; then\n  mise trust ./.mise.toml 2>/dev/null || true\nfi\n\n# Ensure tools are installed (runs once if needed)\nmise install 2>/dev/null || true\n\n# Activate mise to set up PATH with all tools\neval "$(mise activate bash 2>/dev/null || true)"\n\n# Add npm bin directory to PATH for global packages\nNPM_PREFIX=$(mise exec node -- npm config get prefix 2>/dev/null || echo "")\nif [ -n "$NPM_PREFIX" ]; then\n  NPM_BIN="$NPM_PREFIX/bin"\n  if [ -d "$NPM_BIN" ]; then\n    export PATH="$NPM_BIN:$PATH"\n  fi\nfi\n\nif [ $# -eq 0 ]; then\n    # Interactive shell - use zsh with powerline10k\n    exec /bin/zsh -l\nelse\n    # Execute command with tools available\n    exec "$@"\nfi\n' > /usr/local/bin/docker-entrypoint.sh && \
    chmod +x /usr/local/bin/docker-entrypoint.sh

# Switch to agent user for mise setup
USER agent

# Initialize mise
RUN mise --version

# Create .mise.toml with just the default versions (first one from each list)
# This avoids validation warnings about missing secondary versions
RUN /bin/bash -c 'GO_VERSIONS="${GO_VERSIONS}" && NODE_VERSIONS="${NODE_VERSIONS}" && GO_DEFAULT=$(echo "$GO_VERSIONS" | cut -d, -f1) && NODE_DEFAULT=$(echo "$NODE_VERSIONS" | cut -d, -f1) && printf "[tools]\ngo = \"%s\"\nnode = \"%s\"\n" "$GO_DEFAULT" "$NODE_DEFAULT" > /home/agent/.mise.toml'

# Trust .mise.toml and pre-install default tools
RUN cd /home/agent && \
    mise trust /home/agent/.mise.toml && \
    GO_VERSION=$(echo "$GO_VERSIONS" | cut -d, -f1) && \
    NODE_VERSION=$(echo "$NODE_VERSIONS" | cut -d, -f1) && \
    echo "Pre-installing Go $GO_VERSION and Node $NODE_VERSION..." && \
    mise install go@$GO_VERSION && \
    mise install node@$NODE_VERSION

# Install Claude Code using mise exec
RUN cd /home/agent && \
    mise exec node@24 -- npm install -g @anthropic-ai/claude-code@${CLAUDE_CODE_VERSION}

# Create .claude directory for config persistence
RUN mkdir -p /home/agent/.claude && \
    chown -R agent:agent /home/agent/.claude && \
    chmod 755 /home/agent/.claude

# Set working directory
WORKDIR /home/agent/workspace

# Use exec form entrypoint with bash
ENTRYPOINT ["/bin/bash", "/usr/local/bin/docker-entrypoint.sh"]
CMD []
DOCKERFILE_EOF
)

# Default versions
DEFAULT_GO_VERSIONS="1.23.3,1.22.5"
DEFAULT_RUBY_VERSIONS="3.3,3.2"
DEFAULT_NODE_VERSIONS="24,22"
DEFAULT_PYTHON_VERSIONS="3.12,3.11"

# Variables to track what was provided
GO_VERSIONS=""
RUBY_VERSIONS=""
NODE_VERSIONS=""
PYTHON_VERSIONS=""
COMMAND=""
ARGS=()

# Function to ensure docker volume exists
ensure_volume() {
    if ! docker volume inspect agent-volume >/dev/null 2>&1; then
        echo -e "${BLUE}Creating agent-volume for persistent config...${NC}"
        docker volume create agent-volume
    fi
}

# Function to show usage
usage() {
    cat << EOF
${CYAN}Rize - Multi-Language AI Agent Container${NC}

${YELLOW}Usage:${NC}
  rize install                      Install rize globally to ~/.local/bin
  rize build [OPTIONS]              Build Docker image with specified versions
  rize shell                        Start interactive shell in container
  rize claude [args...]             Run claude code in container
  rize run <cmd> [args...]          Run a command in container
  rize exec <cmd> [args...]         Execute a command in container (alias for run)

${YELLOW}Build Options:${NC}
  --go=VERSION_LIST                 Comma-separated Go versions (default: ${DEFAULT_GO_VERSIONS})
  --ruby=VERSION_LIST               Comma-separated Ruby versions (default: ${DEFAULT_RUBY_VERSIONS})
  --node=VERSION_LIST               Comma-separated Node.js versions (default: ${DEFAULT_NODE_VERSIONS})
  --python=VERSION_LIST             Comma-separated Python versions (default: ${DEFAULT_PYTHON_VERSIONS})

${YELLOW}Examples:${NC}
  # Install globally
  rize install

  # Build with default versions
  rize build

  # Build with custom versions
  rize build --go=1.23.3,1.22.5 --ruby=3.3,3.2

  # Start interactive shell
  rize shell

  # Run claude code on current directory
  rize claude .

  # Check Go version
  rize exec go version

${YELLOW}Notes:${NC}
  - Current directory is mounted to /home/agent/workspace in container
  - Claude config persists in agent-volume across runs
  - Commands run with full mise environment

EOF
    exit 0
}

# Parse command line arguments
if [[ $# -eq 0 ]]; then
    usage
fi

COMMAND="$1"
shift

case "$COMMAND" in
    install)
        # Create ~/.local/bin if it doesn't exist
        mkdir -p "$HOME/.local/bin"

        # Check if already installed
        if [[ -f "$HOME/.local/bin/rize" ]] && [[ ! "$FORCE_INSTALL" == "true" ]]; then
            echo -e "${YELLOW}rize is already installed at $HOME/.local/bin/rize${NC}"
            read -p "Overwrite? (y/N): " -n 1 -r
            echo
            if [[ ! $REPLY =~ ^[Yy]$ ]]; then
                exit 0
            fi
        fi

        # Copy script
        cp "$0" "$HOME/.local/bin/rize"
        chmod +x "$HOME/.local/bin/rize"

        # Create volume
        docker volume create agent-volume 2>/dev/null || true

        echo -e "${GREEN}✓ rize installed successfully to $HOME/.local/bin/rize${NC}"
        echo ""

        # Check if image exists, build if not
        if ! docker image inspect rize:latest > /dev/null 2>&1; then
            echo -e "${BLUE}Building Docker image...${NC}"
            "$0" build
        else
            echo -e "${GREEN}✓ Docker image already built${NC}"
            echo ""
        fi

        # Check if ~/.local/bin is in PATH
        if [[ ":$PATH:" != *":$HOME/.local/bin:"* ]]; then
            echo -e "${YELLOW}Note: $HOME/.local/bin is not in your PATH${NC}"
            echo -e "${BLUE}Add this to your shell config (~/.bashrc, ~/.zshrc, etc.):${NC}"
            echo "  export PATH=\"\$HOME/.local/bin:\$PATH\""
            echo ""
        fi

        echo -e "${BLUE}You can now use 'rize' from any directory${NC}"
        echo ""
        echo -e "${YELLOW}Quick start:${NC}"
        echo "  cd ~/your-project"
        echo "  rize shell              # Interactive shell"
        echo "  rize exec go version    # Run commands"
        echo ""
        ;;

    build)
        # Parse build options
        while [[ $# -gt 0 ]]; do
            case "$1" in
                --go=*)
                    GO_VERSIONS="${1#--go=}"
                    shift
                    ;;
                --ruby=*)
                    RUBY_VERSIONS="${1#--ruby=}"
                    shift
                    ;;
                --node=*)
                    NODE_VERSIONS="${1#--node=}"
                    shift
                    ;;
                --python=*)
                    PYTHON_VERSIONS="${1#--python=}"
                    shift
                    ;;
                --help|-h)
                    usage
                    ;;
                *)
                    echo -e "${RED}Unknown option: $1${NC}"
                    usage
                    ;;
            esac
        done

        # Use defaults if not specified
        GO_VERSIONS="${GO_VERSIONS:-$DEFAULT_GO_VERSIONS}"
        RUBY_VERSIONS="${RUBY_VERSIONS:-$DEFAULT_RUBY_VERSIONS}"
        NODE_VERSIONS="${NODE_VERSIONS:-$DEFAULT_NODE_VERSIONS}"
        PYTHON_VERSIONS="${PYTHON_VERSIONS:-$DEFAULT_PYTHON_VERSIONS}"

        echo -e "${CYAN}========================================${NC}"
        echo -e "${CYAN}Building Rize Image${NC}"
        echo -e "${CYAN}========================================${NC}"
        echo ""
        echo -e "${BLUE}Versions:${NC}"
        echo "  Go:     $GO_VERSIONS"
        echo "  Ruby:   $RUBY_VERSIONS"
        echo "  Node:   $NODE_VERSIONS"
        echo "  Python: $PYTHON_VERSIONS"
        echo ""

        # Create temporary directory for Dockerfile
        TEMP_DIR=$(mktemp -d)
        trap "rm -rf $TEMP_DIR" EXIT

        # Write Dockerfile to temp directory
        echo "$DOCKERFILE_CONTENT" > "$TEMP_DIR/Dockerfile"

        # Build the Docker image with build args
        docker build \
            -t rize:latest \
            --build-arg "GO_VERSIONS=$GO_VERSIONS" \
            --build-arg "RUBY_VERSIONS=$RUBY_VERSIONS" \
            --build-arg "NODE_VERSIONS=$NODE_VERSIONS" \
            --build-arg "PYTHON_VERSIONS=$PYTHON_VERSIONS" \
            "$TEMP_DIR"

        echo ""
        echo -e "${GREEN}✓ Docker image built successfully!${NC}"
        echo ""
        echo -e "${YELLOW}Next steps:${NC}"
        echo "  # Start interactive shell"
        echo -e "  ${BLUE}rize shell${NC}"
        echo ""
        echo "  # Run a command"
        echo -e "  ${BLUE}rize run claude .${NC}"
        echo ""
        echo "  # Check versions"
        echo -e "  ${BLUE}rize exec go version${NC}"
        echo ""
        ;;

    shell)
        # Check if image exists
        if ! docker image inspect rize:latest > /dev/null 2>&1; then
            echo -e "${YELLOW}Image not found. Building with default versions...${NC}"
            "$0" build
        fi

        echo -e "${BLUE}Starting interactive shell...${NC}"

        ensure_volume

        # Use -it if TTY is available, otherwise use -i
        TTY_FLAG="-i"
        if [[ -t 0 ]]; then
            TTY_FLAG="-it"
        fi

        docker run --rm $TTY_FLAG \
            -v "$(pwd):/home/agent/workspace" \
            -v "agent-volume:/home/agent/.claude" \
            -v "agent-volume:/home/agent/.cache/gitstatus" \
            -e CLAUDE_CONFIG_DIR=/home/agent/.claude \
            rize:latest
        ;;

    claude)
        # Check if image exists
        if ! docker image inspect rize:latest > /dev/null 2>&1; then
            echo -e "${YELLOW}Image not found. Building with default versions...${NC}"
            "$0" build
        fi

        ensure_volume

        # Use -it if TTY is available, otherwise use -i
        TTY_FLAG="-i"
        if [[ -t 0 ]]; then
            TTY_FLAG="-it"
        fi

        docker run --rm $TTY_FLAG \
            -v "$(pwd):/home/agent/workspace" \
            -v "agent-volume:/home/agent/.claude" \
            -v "agent-volume:/home/agent/.cache/gitstatus" \
            -e CLAUDE_CONFIG_DIR=/home/agent/.claude \
            rize:latest mise exec node@24 -- claude --dangerously-skip-permissions "$@"
        ;;

    run|exec)
        # Check if image exists
        if ! docker image inspect rize:latest > /dev/null 2>&1; then
            echo -e "${YELLOW}Image not found. Building with default versions...${NC}"
            "$0" build
        fi

        if [[ $# -eq 0 ]]; then
            echo -e "${RED}Error: run/exec requires a command${NC}"
            usage
        fi

        echo -e "${BLUE}Running: $@${NC}"

        ensure_volume

        # Use -it if TTY is available, otherwise use -i
        TTY_FLAG="-i"
        if [[ -t 0 ]]; then
            TTY_FLAG="-it"
        fi

        docker run --rm $TTY_FLAG \
            -v "$(pwd):/home/agent/workspace" \
            -v "agent-volume:/home/agent/.claude" \
            -v "agent-volume:/home/agent/.cache/gitstatus" \
            -e CLAUDE_CONFIG_DIR=/home/agent/.claude \
            rize:latest "$@"
        ;;

    --help|-h)
        usage
        ;;

    *)
        echo -e "${RED}Unknown command: $COMMAND${NC}"
        usage
        ;;
esac
